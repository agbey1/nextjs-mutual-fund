// This file is automatically generated by Prisma
// Schema design for Church Mutual Fund App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  ADMIN
  MEMBER
}

enum Gender {
  MALE
  FEMALE
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  SAVINGS_DEPOSIT
  SAVINGS_WITHDRAWAL
  SHARE_PURCHASE
  SHARE_WITHDRAWAL
  LOAN_DISBURSAL
  LOAN_REPAYMENT
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
}

// User Model (for Auth)
model User {
  id            String    @id @default(cuid())
  name          String?
  username      String    @unique // Code/Account Number or Phone
  password      String    // Hashed
  role          Role      @default(MEMBER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  member        Member?
}

// Member Model
model Member {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id])
  
  // Personal Details
  firstName     String
  lastName      String
  otherNames    String?
  gender        Gender
  dateOfBirth   DateTime
  
  // Contact info
  phone         String    @unique
  email         String?
  address       String?
  gps           String?   @map("gpsAddress")
  
  // Banking
  accountNumber String    @unique
  
  // Beneficiary
  beneficiaryName         String?
  beneficiaryRelationship String? @map("beneficiaryRelation")
  beneficiaryAddress      String?
  beneficiaryContact      String?
  
  // Relations
  transactions  Transaction[]
  loanRequests  LoanRequest[]

  // Stats (Optimized for read)
  totalSavings  Decimal   @default(0) 
  totalLoans    Decimal   @default(0) 
  totalShares   Decimal   @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Transaction Model
model Transaction {
  id              String          @id @default(cuid())
  memberId        String
  member          Member          @relation(fields: [memberId], references: [id])
  
  type            TransactionType
  amount          Decimal         
  
  // For Loan Repayments
  interestAmount  Decimal         @default(0) 
  principalAmount Decimal         @default(0) 
  
  description     String?
  receiptNumber   String?         @map("reference")
  date            DateTime        @default(now())
  
  recordedBy      String?         // Admin ID who entered it
  
  // New fields
  paymentCompleted Boolean        @default(true)
  paymentMethod    String?
  isReversal       Boolean        @default(false)
  originalTransactionId String? // self-referencing relation optional

  createdAt       DateTime        @default(now())
}

// Expense Model
model Expense {
  id          String    @id @default(cuid())
  amount      Decimal   
  description String
  category    String?
  date        DateTime  @default(now())
  recordedBy  String?
  
  createdAt   DateTime  @default(now())
}

// Loan Request Model (New)
model LoanRequest {
  id              String    @id @default(cuid())
  memberId        String
  member          Member    @relation(fields: [memberId], references: [id])
  amount          Decimal
  purpose         String?
  repaymentPeriod Int       // Months
  
  interestType    String    @default("PERCENTAGE") // PERCENTAGE | FIXED
  interestRate    Decimal   @default(10)
  interestAmount  Decimal   @default(0) 
  
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED, DISBURSED
  requestedBy     String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Audit Log
model AuditLog {
  id          String   @id @default(cuid())
  action      String
  entityType  String
  entityId    String?
  details     String? // JSON string
  userId      String? @map("performedBy")
  createdAt   DateTime @default(now()) @map("timestamp")
}
